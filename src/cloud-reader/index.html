<!DOCTYPE html>
<html manifest="offlinePebl.appcache">
    <head>
        <meta name="google-site-verification" content="viy9G5ltZp2BNyGobWevcRefx2Xi-BxIBUNRD6maJX4" />
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0">

        <link rel="manifest" href="manifest.json" />

        <link id="readerFavicon" href="" rel="shortcut icon"/>
        <link href="images/PEBL-icon-144.png" rel="apple-touch-icon"/>
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="apple-mobile-web-app-title" content="PeBL eReader">

        <meta name="msapplication-TileImage" content="images/PEBL-icon-144.png">
        <meta name="msapplication-TileColor" content="#000000">


        <style>
         .library-item{
             height: 100px;

         }

         body:not(.list-view) .library-item .no-cover{
             width: 300px;
             height: 400px;
             font-size: 40px;
         }
        </style>

        <link rel="preload" href="fonts/glyphicons-halflings-regular.woff2" as="font">
        <link rel="preload" href="css/annotations.css" as="style">
        <script type="text/javascript" src="scripts/idb-iegap.js"></script>
        <script type="text/javascript" src="scripts/pack.js"></script>
        
        <link xmlns="http://www.w3.org/1999/xhtml" rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous" />
        <link rel="stylesheet" type="text/css" href="css/readium-all.css" async>
        <link rel="stylesheet" type="text/css" href="css/pebl-login-widget.css" async>

        <script type="text/javascript">
         document.getElementById('readerFavicon').setAttribute('href', window.PeBLConfig.favicon);

         if (navigator.serviceWorker) {
             navigator.serviceWorker.register('peblSW.js').then(function (reg) {
                 console.log("Service worker registered", reg.scope);

                 reg.onupdatefound = function () {
                     console.log("Updating worker");
                 }

                 reg.update();
             }).catch(function (err) {
                 console.log("Bad service worker", err);
             });

         }

         var cache = window.applicationCache;
         if (cache) {
             cache.addEventListener('updateready', function (e) {
                 if (cache.status == cache.UPDATEREADY) {
                     cache.swapCache();
                     if (confirm("New Site Version Available, Reload?")) {
                         window.location.reload();
                     }
                 }
             });
             if (cache.status == 1 || cache.status > 3)
                cache.update();
         }

         var path = (window.location && window.location.pathname) ? window.location.pathname : '';

         // extracts path to index.html (or more generally: /PATH/TO/*.[x]html)
         path = path.replace(/(.*)\/.*\.[x]?html$/, "$1");

         // removes trailing slash
         path = path.charAt(path.length-1) == '/'
              ? path.substr(0, path.length-1)
              : path;

         var HTTPServerRootFolder =
             window.location ? (
                 window.location.protocol
                 + "//"
                 + window.location.hostname
                 + (window.location.port ? (':' + window.location.port) : '')
                 + path
             ) : ''
         ;

         console.log(HTTPServerRootFolder);

         var getURLQueryParams = function() {
             var params = {};

             var query = window.location.search;
             if (query && query.length) {
                 query = query.substring(1);
                 var keyParams = query.split('&');
                 for (var x = 0; x < keyParams.length; x++)
                 {
                     var keyVal = keyParams[x].split('=');
                     if (keyVal.length > 1) {
                         params[keyVal[0]] = decodeURIComponent(keyVal[1]);
                     }
                 }
             }

             return params;
         };

         var urlParams = getURLQueryParams();
         console.log(urlParams);

         var fontsArray = [];
         if (typeof getFontFaces != "undefined") { // defined externally
             fontsArray = getFontFaces(HTTPServerRootFolder + "/font-faces/");
         }

         // MUST BE *SINGLE* CALL TO require.config() FOR ALMOND (SINGLE BUNDLE) TO WORK CORRECTLY!!!
         require.config({
             /* http://requirejs.org/docs/api.html#config-waitSeconds */
             waitSeconds: 0,

             config : {

                 'readium_js_viewer/ModuleConfig' : {

                     'mathJaxUrl': HTTPServerRootFolder + '/scripts/mathjax/MathJax.js',

                     'fonts': fontsArray,

                     'annotationCSSUrl': HTTPServerRootFolder + '/css/annotations.css',

                     'jsLibRoot': HTTPServerRootFolder + '/scripts/zip/',

                     'useSimpleLoader' : false, // cloud reader (strictly-speaking, this config option is false by default, but we prefer to have it explicitly set here).

                     'epubLibraryPath': urlParams['epubs'] ? urlParams['epubs'] : "epub_content/epub_library.json",// "epub_library.json", // defaults to /epub_content/epub_library.json relative to the application's root index.html

                     'imagePathPrefix': undefined,

                     'canHandleUrl' : false,
                     'canHandleDirectory' : false,


                     'workerUrl': 'scripts/readium-js-viewer_CLOUDAPP-WORKER.js',
                     'epubReadingSystemUrl': undefined
                 }
             }
         });

         // PEBL.registerReadyCallback(function () {
         //       loadReadiumReader();
         // });
         // loadReadiumReader();
        </script>

    </head>

    <!-- This is all application-specific HTML -->
    <body>
        <nav id="app-navbar" class="navbar" role="banner" aria-label="{{Strings.i18n_toolbar}}">
        </nav>
        <div id="app-container">
        </div>
    </body>

</html>
